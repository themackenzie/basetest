{% extends 'base.html' %}

{% block title %}Reporte de Asistencias Final{% endblock %}

{% block content %}
    
    <div id="calendar-modal" class="report_modal">
        <div class="report_modal_content">
            <span class="report_close_btn">&times;</span>
            <div class="report_calendar_container">
                <h3 class="report_calendar_title">Seleccionar Fecha</h3>
                <div id="calendar-header-simple" class="report_calendar_header">
                    <button id="prev-month" class="report_nav_btn">‚Äπ</button>
                    <h3 id="month-year-display" class="report_month_year"></h3>
                    <button id="next-month" class="report_nav_btn">‚Ä∫</button>
                </div>
                <div class="report_weekdays">
                    <span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span>
                </div>
                <div id="calendar-days" class="report_calendar_days_grid">
                </div>
            </div>
        </div>
    </div>

    <div class="report_main_container">
        <h2 class="report_header">üìÖ Reporte de Asistencia por D√≠a</h2>
        <p class="report_link_wrapper"><a href="{{ url_for('admin_dashboard') }}" class="report_link">‚Üê Volver al Panel Admin</a></p>
        
        <div class="report_filter_controls_simple">
            <label for="date-display-btn" class="report_label">Fecha Seleccionada:</label>
            <button id="date-display-btn" class="report_button report_date_display_btn">
                <span id="current-date-display">üìÖ Seleccionar D√≠a</span>
            </button>
            <input type="hidden" id="date-value-input">

            <button id="export-data-btn" class="report_button report_export_btn" disabled>
                ‚¨áÔ∏è Exportar CSV
            </button>
        </div>
        
        {% if attendances_by_day %}
            <div class="report_table_wrapper">
                <table id="attendanceTable" class="report_table">
                    <thead>
                        <tr class="report_table_header_row">
                            <th class="report_table_cell">Apellido Paterno</th>
                            <th class="report_table_cell">Apellido Materno</th>
                            <th class="report_table_cell">Nombre(s)</th>
                            <th class="report_table_cell report_hidden_column">Fecha</th>
                            <th class="report_table_cell">Tel√©fono</th>
                            <th class="report_table_cell">Hora de Ingreso</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for date_key, records in attendances_by_day.items() %}
                            {% for item in records %}
                                {% set name_parts = item.full_name.split(', ') %}
                                {% set last_names = name_parts[0].split(' ') if name_parts | length > 0 else [''] %}
                                {% set first_name = name_parts[1] if name_parts | length > 1 else '' %}

                                {% set paternal = last_names[0] if last_names | length > 0 else '' %}
                                {% set maternal = last_names[1] if last_names | length > 1 and last_names[1] != '' else '' %}

                                <tr class="report_table_row {% if loop.index is even %}report_table_even{% else %}report_table_odd{% endif %}">
                                    <td class="report_table_cell">{{ paternal }}</td>
                                    <td class="report_table_cell">{{ maternal }}</td>
                                    <td class="report_table_cell">{{ first_name }}</td>
                                    <td class="report_table_cell report_hidden_column">{{ date_key }}</td>
                                    <td class="report_table_cell">{{ item.phone_number if item.phone_number is defined else 'N/A' }}</td>
                                    <td class="report_table_cell">{{ item.time }}</td>
                                </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="report_no_data">A√∫n no hay registros de asistencia en la base de datos.</p>
        {% endif %}
    </div>

    ---

    <style>
        /* Contenedor Principal */
        .report_main_container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .report_header {
            text-align: center;
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .report_link_wrapper {
            text-align: center;
            margin-bottom: 20px;
        }
        .report_link {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
        }
        .report_link:hover {
            text-decoration: underline;
        }

        /* Controles de Filtro */
        .report_filter_controls_simple {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .report_label {
            font-weight: bold;
            color: #333;
        }
        .report_button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: inherit;
        }
        
        /* Estilo Bot√≥n Principal de Fecha */
        .report_date_display_btn {
            font-size: 1.1em;
            padding: 10px 15px;
            min-width: 220px;
            text-align: left;
            background-color: #3498db;  
        }
        .report_date_display_btn:hover {
            background-color: #2980b9;
        }

        /* Estilo Bot√≥n de Exportaci√≥n */
        .report_export_btn {
            background-color: #2ecc71;
            font-weight: bold;
        }
        .report_export_btn:hover:not(:disabled) {
            background-color: #27ae60;
        }
        .report_export_btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Estilos de la Tabla */
        .report_table_wrapper {
            overflow-x: auto;
        }
        .report_table {
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.9em;
            min-width: 400px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        .report_table_header_row {
            background-color: #3498db;
            color: white;
            text-align: left;
        }
        .report_table_cell {
            padding: 12px 15px;
            border: 1px solid #dddddd;
        }
        .report_table_even {
            background-color: #f3f3f3;
        }
        .report_table_odd {
            background-color: #ffffff;
        }
        .report_table_row:hover {
            background-color: #e6f7ff;
            cursor: default;
        }
        .report_hidden_column {
            display: none;
        }
        .report_no_data {
            text-align: center;
            color: #888;
            margin-top: 30px;
        }

        /* NUEVOS ESTILOS PARA ORDENACI√ìN */
        .report_sortable_header {
            cursor: pointer;
            position: relative;
        }

        .report_sortable_header:hover {
            background-color: #2980b9;
        }

        /* Indicador de estado (tri√°ngulo) */
        .asc::after {
            content: '‚ñ≤';
            opacity: 1;
            font-size: 10px;
            color: white;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        .desc::after {
            content: '‚ñº';
            opacity: 1;
            font-size: 10px;
            color: white;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Estilos del Modal del Calendario */
        .report_modal {
            display: none;  
            position: fixed; 
            z-index: 1000;  
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .report_modal_content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 350px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .report_close_btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .report_close_btn:hover, .report_close_btn:focus {
            color: #e74c3c;
            text-decoration: none;
        }

        /* Estilos del Calendario */
        .report_calendar_container {
            padding: 10px;
            text-align: center;
        }
        .report_calendar_title {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .report_calendar_header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .report_month_year {
            margin: 0;
            font-size: 1.1em;
            color: #3498db;
        }
        .report_nav_btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #3498db;
            padding: 0 10px;
        }
        .report_nav_btn:hover {
            color: #2980b9;
        }
        .report_weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: bold;
            color: #7f8c8d;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .report_calendar_days_grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .report_day { 
            padding: 8px 5px; 
            text-align: center; 
            border: 1px solid #eee; 
            border-radius: 4px; 
            cursor: pointer; 
            background-color: #fff; 
            height: 35px; 
            line-height: 19px; 
            font-size: 0.9em; 
            transition: background-color 0.1s;
        }
        .report_day:hover:not(.report_inactive):not(.report_selected) { 
            background-color: #ecf0f1; 
        }
        /* Clases de Estado Din√°mico de JS */
        .report_inactive { 
            color: #ccc; 
            background-color: #fafafa; 
            cursor: default; 
        }
        .report_has_data { 
            border-color: #2ecc71; 
            font-weight: bold; 
        }
        .report_selected { 
            background-color: #3498db; 
            color: white; 
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); 
            border-color: #3498db; 
        }
    </style>

    ---

    <script>
        // 1. INICIALIZACI√ìN DE VARIABLES GLOBALES
        const ATTENDANCE_DATA = {{ attendances_by_day | tojson }}; 
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        
        // Elementos de la interfaz
        const dateDisplayButton = document.getElementById('date-display-btn');
        const currentDateDisplay = document.getElementById('current-date-display');
        const dateValueInput = document.getElementById('date-value-input');
        const attendanceTable = document.getElementById('attendanceTable');
        const attendanceTableBody = attendanceTable ? attendanceTable.querySelector('tbody') : null;
        const exportDataBtn = document.getElementById('export-data-btn');
        
        const modal = document.getElementById('calendar-modal');
        const closeBtn = document.querySelector('.report_close_btn');
        const calendarDays = document.getElementById('calendar-days');
        const monthYearDisplay = document.getElementById('month-year-display');
        
        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        // Estado de ordenaci√≥n
        let currentSortColumn = -1;
        let currentSortDirection = 'asc';

        // 2. FUNCI√ìN DE AYUDA Y MODAL
        function formatDate(year, month, day) {
            const m = String(month + 1).padStart(2, '0');
            const d = String(day).padStart(2, '0');
            return `${year}-${m}-${d}`; // Formato YYYY-MM-DD
        }

        function openModal() { modal.style.display = 'block'; }
        function closeModal() { modal.style.display = 'none'; }
        
        // 3. FUNCI√ìN DE ORDENACI√ìN DE TABLA
        function sortTableByColumn(columnIndex) {
            if (!attendanceTableBody) return;

            const rowsArray = Array.from(attendanceTableBody.querySelectorAll('tr'));

            // 1. Determinar direcci√≥n de ordenaci√≥n
            let direction = currentSortDirection;
            if (currentSortColumn === columnIndex) {
                direction = direction === 'asc' ? 'desc' : 'asc';
            } else {
                direction = 'asc';
            }

            // 2. Funci√≥n de comparaci√≥n
            const comparator = (rowA, rowB) => {
                // Obtener el valor de la celda, convertir a min√∫sculas para una comparaci√≥n case-insensitive
                const cellA = rowA.cells[columnIndex].textContent.trim().toLowerCase();
                const cellB = rowB.cells[columnIndex].textContent.trim().toLowerCase();
                
                let comparison = 0;
                if (cellA > cellB) {
                    comparison = 1;
                } else if (cellA < cellB) {
                    comparison = -1;
                }

                return direction === 'asc' ? comparison : comparison * -1;
            };

            // 3. Ordenar solo las filas VISIBLES
            const visibleRows = rowsArray.filter(row => row.style.display !== 'none');
            const hiddenRows = rowsArray.filter(row => row.style.display === 'none');

            visibleRows.sort(comparator);

            // 4. Actualizar el estado y redibujar la tabla
            currentSortColumn = columnIndex;
            currentSortDirection = direction;

            // Limpiar indicadores de ordenaci√≥n
            const headers = attendanceTable.querySelectorAll('th');
            headers.forEach(th => th.classList.remove('asc', 'desc'));

            // Aplicar indicador de ordenaci√≥n al encabezado actual
            const currentHeader = headers[columnIndex];
            if (currentHeader) {
                currentHeader.classList.add(direction);
            }

            // Reconstruir el cuerpo de la tabla
            attendanceTableBody.innerHTML = '';
            
            // Adjuntar filas ordenadas y reaplicar el estilo alterno
            visibleRows.forEach((row, index) => {
                row.classList.remove('report_table_even', 'report_table_odd');
                row.classList.add(index % 2 === 0 ? 'report_table_odd' : 'report_table_even');
                attendanceTableBody.appendChild(row);
            });
            
            // Adjuntar filas ocultas al final
            hiddenRows.forEach(row => attendanceTableBody.appendChild(row));
        }


        // 4. FUNCI√ìN PARA CONFIGURAR LA ORDENACI√ìN
        function setupSortableTable() {
            if (!attendanceTable) return;
            const headers = attendanceTable.querySelectorAll('th');
            // CAMBIO: Se ajustan los √≠ndices de las columnas ordenables: 
            // 0=APaterno, 1=AMaterno, 2=Nombre, 4=Tel√©fono (NUEVO), 5=Hora Ingreso (Ajustado)
            const sortableIndices = [0, 1, 2, 4, 5]; 

            headers.forEach((header, index) => {
                if (sortableIndices.includes(index)) {
                    header.classList.add('report_sortable_header'); 
                    
                    header.addEventListener('click', () => {
                        sortTableByColumn(index);
                    });
                }
            });
        }


        // 5. FUNCI√ìN DE EXPORTACI√ìN
        function exportToCSV() {
            const dateKey = dateValueInput.value;
            if (!dateKey) {
                alert("Por favor, selecciona un d√≠a con registros para exportar.");
                return;
            }

            const records = ATTENDANCE_DATA[dateKey];
            if (!records || records.length === 0) {
                alert(`No hay registros para la fecha ${dateKey}.`);
                return;
            }

            // CAMBIO: Se agrega "Tel√©fono" al encabezado del CSV
            let csvContent = "Apellido Paterno,Apellido Materno,Nombre(s),Tel√©fono,Hora de Ingreso\n";

            // Cuerpo del CSV
            records.forEach(item => {
                const nameParts = item.full_name.split(', ');
                const lastNames = nameParts[0] ? nameParts[0].split(' ') : [''];
                const firstName = nameParts[1] || '';

                const paternal = lastNames[0] || '';
                const maternal = lastNames[1] || '';
                // CAMBIO: Se usa 'phone_number' para obtener el valor
                const phone = item.phone_number || ''; 

                const row = `"${paternal}","${maternal}","${firstName}","${phone}","${item.time}"`;
                csvContent += row + "\n";
            });

            // Crea el archivo y descarga
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Reporte_Asistencia_${dateKey}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }


        // 6. FUNCI√ìN DE FILTRADO
        function filterAttendanceByDate(dateKey) {
            
            // Actualizar la fecha visible en el bot√≥n y el valor oculto
            const hasData = dateKey !== 'initial' && ATTENDANCE_DATA.hasOwnProperty(dateKey) && ATTENDANCE_DATA[dateKey].length > 0;

            if (dateKey !== 'initial') {
                currentDateDisplay.textContent = `üìÖ ${dateKey}`;
                dateValueInput.value = dateKey;
            } else {
                currentDateDisplay.textContent = `üìÖ Seleccionar D√≠a`;
                dateValueInput.value = '';
            }

            // Resetear el estado de ordenaci√≥n y remover indicadores visuales
            currentSortColumn = -1;
            currentSortDirection = 'asc';
            const headers = attendanceTable.querySelectorAll('th');
            headers.forEach(th => th.classList.remove('asc', 'desc'));

            // Habilitar/Deshabilitar el bot√≥n de exportaci√≥n
            exportDataBtn.disabled = !hasData;
            
            // 7. Iterar y filtrar las filas de la tabla
            if (attendanceTableBody) {
                const rows = attendanceTableBody.querySelectorAll('tr');
                let foundRecords = false;
                let visibleCount = 0;

                rows.forEach(row => {
                    // La columna de Fecha sigue siendo el √≠ndice [3]
                    const dateInRow = row.cells[3].textContent.trim(); 
                    const isMatch = (dateInRow === dateKey);

                    if (dateKey === 'initial') {
                        row.style.display = 'none';
                    } else if (isMatch) {
                        row.style.display = '';
                        foundRecords = true;
                        // Reaplicar estilos de fondo alternos despu√©s del filtro
                        row.classList.remove('report_table_even', 'report_table_odd');
                        row.classList.add(visibleCount % 2 === 0 ? 'report_table_odd' : 'report_table_even');
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                if (dateKey !== 'initial' && !foundRecords) {
                    exportDataBtn.disabled = true;
                }
            }
        }

        // 8. RENDERIZADO DEL CALENDARIO
        function renderCalendar() {
            calendarDays.innerHTML = '';
            
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();

            monthYearDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('report_day', 'report_inactive');
                calendarDays.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('report_day');
                dayElement.textContent = day;

                const dateKey = formatDate(currentYear, currentMonth, day);
                
                if (ATTENDANCE_DATA.hasOwnProperty(dateKey) && ATTENDANCE_DATA[dateKey].length > 0) {
                    dayElement.classList.add('report_has_data');
                    
                    dayElement.addEventListener('click', () => {
                        filterAttendanceByDate(dateKey);
                        closeModal(); 
                    });
                } else {
                    dayElement.classList.add('report_inactive'); 
                }
                
                if (dateValueInput.value === dateKey) {
                    dayElement.classList.add('report_selected');
                }

                calendarDays.appendChild(dayElement);
            }
        }

        // 9. MANEJO DE EVENTOS
        dateDisplayButton.addEventListener('click', () => {
            renderCalendar(); 
            openModal();
        });

        closeBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });

        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            currentYear = currentMonth === 11 ? currentYear - 1 : currentYear;
            renderCalendar();
        });

        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth = currentMonth === 11 ? 0 : currentMonth + 1;
            currentYear = currentMonth === 0 ? currentYear + 1 : currentYear;
            renderCalendar();
        });

        exportDataBtn.addEventListener('click', exportToCSV);

        // 10. INICIALIZACI√ìN
        setupSortableTable();
        filterAttendanceByDate('initial'); 
        renderCalendar(); 
    </script>
{% endblock %}